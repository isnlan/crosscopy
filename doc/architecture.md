# CrossCopy 架构设计文档

## 1. 系统概述

CrossCopy 是一个基于 Rust 开发的跨平台剪贴板同步工具，支持 Windows、macOS 和 Linux 系统。通过局域网或远程网络实现多设备间的剪贴板内容实时同步，提供类似 Apple Handoff 的无缝体验。

## 2. 架构设计原则

### 2.1 设计目标
- **跨平台兼容性**：支持主流桌面操作系统
- **实时性**：毫秒级的剪贴板内容同步
- **安全性**：端到端加密保护数据隐私
- **轻量化**：最小化系统资源占用
- **可扩展性**：模块化设计便于功能扩展

### 2.2 核心原则
- **异步优先**：基于 Tokio 异步运行时
- **事件驱动**：响应式的剪贴板监听机制
- **去中心化**：点对点通信，无需中央服务器
- **配置驱动**：灵活的配置管理系统

## 3. 系统架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    CrossCopy Application                    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Clipboard   │  │ Network     │  │ Configuration       │  │
│  │ Monitor     │  │ Manager     │  │ Manager             │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ Encryption  │  │ Message     │  │ Event               │  │
│  │ Service     │  │ Protocol    │  │ Bus                 │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    Platform Abstraction Layer              │
├─────────────────────────────────────────────────────────────┤
│  Windows API    │    macOS API    │    Linux API           │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 核心模块

#### 3.2.1 剪贴板监控模块 (Clipboard Monitor)
- **职责**：监听系统剪贴板变化
- **实现**：基于 `arboard` crate 的跨平台剪贴板访问
- **特性**：
  - 支持文本和图片内容检测
  - 智能去抖动机制
  - 内容变化事件触发

#### 3.2.2 网络管理模块 (Network Manager)
- **职责**：处理设备间的网络通信
- **实现**：基于 `tokio-tungstenite` 的 WebSocket 通信
- **特性**：
  - 支持 TCP/WebSocket 双协议
  - 自动重连机制
  - 连接状态管理

#### 3.2.3 加密服务模块 (Encryption Service)
- **职责**：提供端到端加密保护
- **实现**：基于 `aes-gcm` 的对称加密
- **特性**：
  - AES-GCM 加密算法
  - 密钥派生和管理
  - 消息完整性验证

#### 3.2.4 配置管理模块 (Configuration Manager)
- **职责**：管理应用配置和设备信息
- **实现**：基于 `confy` 的配置文件管理
- **特性**：
  - TOML 格式配置文件
  - 跨平台配置路径
  - 动态配置更新

## 4. 数据流设计

### 4.1 剪贴板同步流程

```
Device A                           Device B
   │                                 │
   ├─ 1. 检测剪贴板变化               │
   ├─ 2. 内容去重和去抖动             │
   ├─ 3. 序列化内容                  │
   ├─ 4. 加密数据                    │
   ├─ 5. 发送到对等设备 ──────────────┤
   │                                 ├─ 6. 接收加密数据
   │                                 ├─ 7. 解密和验证
   │                                 ├─ 8. 反序列化内容
   │                                 ├─ 9. 更新本地剪贴板
   │                                 └─ 10. 触发同步完成事件
```

### 4.2 消息协议设计

```rust
#[derive(Serialize, Deserialize)]
pub struct ClipboardMessage {
    pub message_id: String,
    pub device_id: String,
    pub timestamp: u64,
    pub content_type: ContentType,
    pub content: Vec<u8>,
    pub checksum: String,
}

#[derive(Serialize, Deserialize)]
pub enum ContentType {
    Text,
    Image,
    File,
}
```

## 5. 安全设计

### 5.1 加密策略
- **算法选择**：AES-256-GCM 提供加密和认证
- **密钥管理**：基于共享密钥的对称加密
- **密钥派生**：使用 PBKDF2 从用户密钥派生加密密钥

### 5.2 安全特性
- **传输加密**：所有网络传输内容加密
- **消息认证**：防止消息篡改
- **重放攻击防护**：时间戳和消息ID验证
- **密钥轮换**：支持定期更新加密密钥

## 6. 性能优化

### 6.1 异步处理
- **非阻塞IO**：基于 Tokio 异步运行时
- **并发处理**：多设备并发同步
- **资源池化**：连接和缓冲区复用

### 6.2 内存管理
- **零拷贝**：最小化数据复制
- **流式处理**：大文件分块传输
- **缓存策略**：智能内容缓存

### 6.3 网络优化
- **压缩传输**：可选的内容压缩
- **批量处理**：多个变更合并发送
- **自适应重试**：智能重连策略

## 7. 扩展性设计

### 7.1 插件架构
- **模块化设计**：核心功能模块化
- **接口标准化**：统一的插件接口
- **动态加载**：运行时插件加载

### 7.2 协议扩展
- **版本兼容**：向后兼容的协议版本
- **自定义协议**：支持扩展消息类型
- **传输层抽象**：支持多种传输协议

## 8. 部署架构

### 8.1 单机部署
```
┌─────────────────────────────────┐
│         CrossCopy               │
│  ┌─────────────────────────────┐│
│  │     Main Process            ││
│  │  ┌─────────┐ ┌─────────────┐││
│  │  │Clipboard│ │   Network   │││
│  │  │Monitor  │ │   Service   │││
│  │  └─────────┘ └─────────────┘││
│  └─────────────────────────────┘│
└─────────────────────────────────┘
```

### 8.2 多设备网络拓扑
```
     Device A ────────┐
         │            │
         │            │
     Device B ────────┼────── Device D
         │            │
         │            │
     Device C ────────┘
```

## 9. 监控和日志

### 9.1 日志系统
- **分级日志**：ERROR、WARN、INFO、DEBUG、TRACE
- **结构化日志**：JSON 格式的结构化输出
- **日志轮转**：自动日志文件管理

### 9.2 监控指标
- **性能指标**：同步延迟、吞吐量、错误率
- **系统指标**：CPU、内存、网络使用率
- **业务指标**：同步成功率、设备在线状态

## 10. 故障处理

### 10.1 容错机制
- **自动重连**：网络断开自动重连
- **降级服务**：部分功能故障时的降级策略
- **数据恢复**：异常情况下的数据恢复

### 10.2 错误处理
- **分类处理**：不同类型错误的处理策略
- **用户反馈**：友好的错误提示
- **自动修复**：可自动修复的问题处理
