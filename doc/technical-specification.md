# CrossCopy 技术规格说明

## 1. 系统要求

### 1.1 硬件要求

#### 最低配置
- **CPU**：x86_64 或 ARM64 架构，1GHz 或更高
- **内存**：256MB 可用 RAM
- **存储**：100MB 可用磁盘空间
- **网络**：支持 TCP/IP 的网络接口

#### 推荐配置
- **CPU**：多核处理器，2GHz 或更高
- **内存**：1GB 可用 RAM
- **存储**：500MB 可用磁盘空间
- **网络**：千兆以太网或 Wi-Fi 802.11n

### 1.2 软件要求

#### 操作系统支持
| 操作系统 | 最低版本 | 推荐版本 | 架构支持 |
|---------|---------|---------|---------|
| Windows | Windows 10 | Windows 11 | x86_64 |
| macOS | 10.15 (Catalina) | 13.0 (Ventura) | x86_64, ARM64 |
| Linux | Ubuntu 18.04 | Ubuntu 22.04 | x86_64, ARM64 |
| Linux | CentOS 7 | CentOS 8 | x86_64 |
| Linux | Debian 10 | Debian 11 | x86_64, ARM64 |

#### 运行时依赖
- **Rust Runtime**：无需额外运行时（静态链接）
- **系统库**：
  - Windows: User32.dll, Kernel32.dll
  - macOS: AppKit.framework, Foundation.framework
  - Linux: libX11, libxcb, libgtk-3

## 2. 网络协议规格

### 2.1 传输协议

#### WebSocket 协议
- **版本**：RFC 6455
- **端口**：8888 (默认，可配置)
- **子协议**：crosscopy-v1
- **帧类型**：Binary (主要), Text (控制消息)

#### TCP 协议
- **版本**：IPv4/IPv6
- **端口范围**：1024-65535 (可配置)
- **连接类型**：长连接，支持连接池
- **超时设置**：连接超时 5s，读写超时 30s

### 2.2 消息格式

#### 消息头格式
```
+------------------+------------------+------------------+------------------+
|    Magic (4B)    |   Version (2B)   |    Type (2B)     |   Length (4B)    |
+------------------+------------------+------------------+------------------+
|                           Timestamp (8B)                                |
+------------------+------------------+------------------+------------------+
|                           Device ID (16B)                               |
+------------------+------------------+------------------+------------------+
|                           Message ID (16B)                              |
+------------------+------------------+------------------+------------------+
|                           Checksum (32B)                                |
+------------------+------------------+------------------+------------------+
```

#### 字段说明
- **Magic**: 0x43505354 ("CPST")
- **Version**: 协议版本号 (当前为 0x0001)
- **Type**: 消息类型 (见消息类型表)
- **Length**: 负载长度 (字节)
- **Timestamp**: Unix 时间戳 (毫秒)
- **Device ID**: 设备唯一标识符
- **Message ID**: 消息唯一标识符
- **Checksum**: SHA-256 校验和

#### 消息类型
| 类型值 | 名称 | 描述 |
|-------|------|------|
| 0x0001 | HANDSHAKE | 握手消息 |
| 0x0002 | HEARTBEAT | 心跳消息 |
| 0x0003 | CLIPBOARD_SYNC | 剪贴板同步 |
| 0x0004 | DEVICE_INFO | 设备信息 |
| 0x0005 | ACK | 确认消息 |
| 0x0006 | ERROR | 错误消息 |

### 2.3 连接流程

#### 握手流程
```
Client                                Server
  |                                     |
  |----------- HANDSHAKE ------------->|
  |<---------- CHALLENGE --------------|
  |----------- RESPONSE -------------->|
  |<---------- ACK/ERROR --------------|
  |                                     |
  |----------- HEARTBEAT ------------->|
  |<---------- HEARTBEAT --------------|
```

#### 认证流程
```
1. Client 发送 HANDSHAKE 消息，包含设备 ID 和能力信息
2. Server 返回 CHALLENGE 消息，包含随机挑战数据
3. Client 使用共享密钥对挑战进行 HMAC 签名，发送 RESPONSE
4. Server 验证签名，返回 ACK 或 ERROR
5. 建立加密通道，开始心跳保活
```

## 3. 数据格式规格

### 3.1 剪贴板内容格式

#### 文本格式
```json
{
  "type": "text",
  "encoding": "utf-8",
  "content": "base64_encoded_text",
  "metadata": {
    "length": 1024,
    "language": "en-US",
    "mime_type": "text/plain"
  }
}
```

#### 图片格式
```json
{
  "type": "image",
  "format": "png",
  "content": "base64_encoded_image_data",
  "metadata": {
    "width": 1920,
    "height": 1080,
    "size": 2048576,
    "color_depth": 24,
    "compression": "deflate"
  }
}
```

#### 文件格式
```json
{
  "type": "files",
  "content": [
    {
      "path": "/path/to/file1.txt",
      "size": 1024,
      "modified": 1640995200,
      "checksum": "sha256_hash"
    }
  ],
  "metadata": {
    "total_size": 1024,
    "file_count": 1,
    "base_path": "/common/path"
  }
}
```

### 3.2 配置文件格式

#### TOML 配置结构
```toml
[device]
name = "string"           # 设备名称
id = "string"             # 设备 ID (自动生成)

[network]
listen_port = 8888        # 监听端口
peer_list = []            # 对等设备列表
connection_timeout = 5000 # 连接超时 (毫秒)
heartbeat_interval = 1000 # 心跳间隔 (毫秒)
max_connections = 10      # 最大连接数
enable_ipv6 = true        # 启用 IPv6
bind_interface = "0.0.0.0" # 绑定接口

[clipboard]
sync_images = true        # 同步图片
sync_files = false        # 同步文件
sync_rich_text = true     # 同步富文本
cooldown_millis = 300     # 去抖动时间 (毫秒)
max_content_size = 10485760 # 最大内容大小 (字节)
max_history_size = 100    # 历史记录大小

[security]
secret_key = "string"     # 共享密钥
enable_encryption = true  # 启用加密
enable_authentication = true # 启用认证
key_rotation_interval = 86400 # 密钥轮换间隔 (秒)
allowed_ips = []          # IP 白名单
blocked_ips = []          # IP 黑名单

[logging]
level = "info"            # 日志级别
file_path = "string"      # 日志文件路径
max_file_size = 10485760  # 最大文件大小
max_files = 5             # 最大文件数量
enable_console = true     # 启用控制台输出
```

## 4. 加密规格

### 4.1 加密算法

#### 对称加密
- **算法**：AES-256-GCM
- **密钥长度**：256 位 (32 字节)
- **IV 长度**：96 位 (12 字节)
- **标签长度**：128 位 (16 字节)

#### 密钥派生
- **算法**：PBKDF2-HMAC-SHA256
- **迭代次数**：100,000
- **盐长度**：256 位 (32 字节)
- **输出长度**：256 位 (32 字节)

#### 消息认证
- **算法**：HMAC-SHA256
- **密钥长度**：256 位 (32 字节)
- **输出长度**：256 位 (32 字节)

### 4.2 加密数据格式

#### 加密消息结构
```
+------------------+------------------+------------------+
|      IV (12B)    |   Ciphertext     |     Tag (16B)    |
+------------------+------------------+------------------+
```

#### 认证消息结构
```
+------------------+------------------+
|   Message Data   |   HMAC (32B)     |
+------------------+------------------+
```

## 5. 性能规格

### 5.1 性能指标

#### 延迟要求
- **本地剪贴板检测**：< 100ms
- **网络传输延迟**：< 200ms (局域网)
- **加密/解密时间**：< 50ms (1MB 数据)
- **端到端同步延迟**：< 500ms

#### 吞吐量要求
- **文本同步**：> 1000 次/秒
- **图片同步**：> 100MB/秒
- **并发连接**：> 50 个设备
- **消息处理**：> 10000 消息/秒

#### 资源使用
- **内存占用**：< 100MB (空闲状态)
- **CPU 使用率**：< 5% (空闲状态)
- **网络带宽**：< 1MB/秒 (正常使用)
- **磁盘 I/O**：< 10MB/秒

### 5.2 扩展性要求

#### 水平扩展
- **最大设备数**：1000 个设备
- **网络拓扑**：支持星型、网状拓扑
- **负载均衡**：支持多个中继节点
- **故障转移**：自动故障检测和恢复

#### 垂直扩展
- **内存扩展**：支持 1GB+ 内存使用
- **存储扩展**：支持 TB 级历史数据
- **处理能力**：支持多核并行处理
- **网络带宽**：支持千兆网络

## 6. 兼容性规格

### 6.1 向后兼容性

#### 协议版本兼容
- **主版本**：不兼容，需要升级所有设备
- **次版本**：向后兼容，支持功能降级
- **修订版本**：完全兼容

#### 配置文件兼容
- **自动迁移**：支持旧版本配置自动升级
- **格式转换**：支持多种配置格式
- **默认值处理**：新增配置项使用合理默认值

### 6.2 平台兼容性

#### 剪贴板格式
| 平台 | 文本格式 | 图片格式 | 文件格式 |
|------|---------|---------|---------|
| Windows | CF_TEXT, CF_UNICODETEXT | CF_BITMAP, CF_DIB | CF_HDROP |
| macOS | NSStringPboardType | NSPasteboardTypePNG | NSFilenamesPboardType |
| Linux | text/plain, text/utf8 | image/png, image/jpeg | text/uri-list |

#### 字符编码
- **Windows**：UTF-16LE (系统默认)
- **macOS**：UTF-8
- **Linux**：UTF-8
- **网络传输**：UTF-8 (统一编码)

## 7. 质量保证

### 7.1 测试覆盖率

#### 单元测试
- **代码覆盖率**：> 90%
- **分支覆盖率**：> 85%
- **函数覆盖率**：> 95%

#### 集成测试
- **端到端测试**：所有主要功能
- **跨平台测试**：所有支持的操作系统
- **性能测试**：负载和压力测试

#### 安全测试
- **渗透测试**：定期安全评估
- **模糊测试**：输入验证测试
- **加密测试**：密码学实现验证

### 7.2 质量标准

#### 可靠性
- **MTBF**：> 720 小时 (30 天)
- **故障恢复时间**：< 30 秒
- **数据完整性**：99.99%

#### 可用性
- **系统可用性**：99.9%
- **响应时间**：< 1 秒
- **错误率**：< 0.1%

## 8. 部署规格

### 8.1 安装包规格

#### 包大小
- **Windows**：< 20MB (MSI 安装包)
- **macOS**：< 25MB (DMG 镜像)
- **Linux**：< 15MB (DEB/RPM 包)

#### 安装要求
- **管理员权限**：Windows 需要，macOS/Linux 可选
- **依赖检查**：自动检查和安装依赖
- **配置初始化**：自动生成默认配置

### 8.2 运行环境

#### 服务模式
- **Windows**：Windows 服务
- **macOS**：LaunchDaemon
- **Linux**：systemd 服务

#### 用户模式
- **自启动**：支持开机自启动
- **托盘图标**：系统托盘集成
- **通知系统**：系统通知集成

---

**版本**：v1.0.0  
**最后更新**：2025年1月  
**维护者**：CrossCopy 技术团队
